name: Release Pipeline

on:
  push:
    tags:
      - '*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Extract version and date
        id: version-info
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          RELEASE_DATE=$(date -u +"%Y-%m-%d")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release-date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Extracted Version: $VERSION"
          echo "ðŸ“… Release Date: $RELEASE_DATE"
          
      - name: Update version.ts file
        run: |
          echo "ðŸ”„ Updating version.ts with release information..."
          
          cat > frontend/src/version.ts << EOF
          export const VERSION_INFO = {
            version: '${{ steps.version-info.outputs.version }}',
            releaseDate: '${{ steps.version-info.outputs.release-date }}',
            environment: 'production'
          } as const;
          
          export const getVersionString = () => \`v\${VERSION_INFO.version}\`;
          export const getReleaseDate = () => VERSION_INFO.releaseDate;
          export const getEnvironment = () => VERSION_INFO.environment;
          EOF
          
          echo "âœ… Updated version.ts:"
          cat frontend/src/version.ts
          
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push backend Docker image
        run: |
          echo "ðŸ³ Building and pushing backend Docker image..."
          
          # Build backend image with version tag
          docker build -f backend/Dockerfile -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version-info.outputs.version }} .
          
          # Tag as latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version-info.outputs.version }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          
          # Push both tags
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version-info.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          
          echo "âœ… Backend image pushed successfully!"
          
      - name: Build and push frontend Docker image  
        run: |
          echo "ðŸ³ Building and pushing frontend Docker image..."
          
          # Build frontend image with version tag
          docker build -f frontend/Dockerfile -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version-info.outputs.version }} .
          
          # Tag as latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version-info.outputs.version }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          
          # Push both tags
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version-info.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          
          echo "âœ… Frontend image pushed successfully!"
          
      - name: Install kubectl
        run: |
          echo "âš™ï¸ Installing kubectl..."
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          echo "âœ… kubectl installed successfully!"
          kubectl version --client
          
      - name: Install Helm
        run: |
          echo "âš™ï¸ Installing Helm..."
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          echo "âœ… Helm installed successfully!"
          helm version
          
      - name: Setup Kubernetes cluster access
        if: ${{ secrets.KUBE_CONFIG != '' }}
        run: |
          echo "ðŸ”§ Setting up Kubernetes cluster access..."
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # Test cluster connectivity
          if kubectl cluster-info > /dev/null 2>&1; then
            echo "âœ… Successfully connected to Kubernetes cluster"
            echo "KUBE_ACCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ Failed to connect to Kubernetes cluster"
            echo "KUBE_ACCESS=false" >> $GITHUB_ENV
          fi
          
      - name: Deploy to Kubernetes with Helm
        if: env.KUBE_ACCESS == 'true'
        run: |
          echo "ðŸš€ Deploying DelBot version ${{ steps.version-info.outputs.version }} to Kubernetes..."
          
          # Deploy using Helm
          helm upgrade --install delbot ./delbot-chart \
            --set backend.image.tag=${{ steps.version-info.outputs.version }} \
            --set frontend.image.tag=${{ steps.version-info.outputs.version }} \
            --set commonLabels.version=${{ steps.version-info.outputs.version }} \
            --wait --timeout=300s
          
          echo "âœ… Deployment completed successfully!"
          
          # Wait for pods to be ready
          echo "â³ Waiting for all pods to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment/delbot-backend -n delbot
          kubectl wait --for=condition=available --timeout=300s deployment/delbot-frontend -n delbot
          
          echo "âœ… All pods are ready!"
          
          # Show deployment status
          echo "ðŸ“Š Deployment Status:"
          kubectl get pods -n delbot
          
          # Show running versions
          echo "ðŸ·ï¸ Deployed Versions:"
          echo "Backend: $(kubectl get deployment delbot-backend -n delbot -o jsonpath='{.spec.template.spec.containers[0].image}')"
          echo "Frontend: $(kubectl get deployment delbot-frontend -n delbot -o jsonpath='{.spec.template.spec.containers[0].image}')"
          
      - name: Show published images
        run: |
          echo "ðŸ“‹ Published Docker images:"
          echo "Backend:"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version-info.outputs.version }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest"
          echo "Frontend:"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version-info.outputs.version }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest"
          
      - name: Create release summary
        run: |
          echo "ðŸŽ‰ **Release ${{ steps.version-info.outputs.version }} Complete!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Date:** ${{ steps.version-info.outputs.release-date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Tasks" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Extracted version from tag" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Updated version.ts file" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Built and pushed backend Docker image" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Built and pushed frontend Docker image" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Installed kubectl and Helm" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.KUBE_ACCESS }}" == "true" ]; then
            echo "- [x] Deployed to Kubernetes cluster successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ ] Kubernetes deployment (cluster access not configured)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Docker Images Published" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:**" >> $GITHUB_STEP_SUMMARY
          echo "- [\`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version-info.outputs.version }}\`](https://github.com/${{ github.repository }}/pkgs/container/backend)" >> $GITHUB_STEP_SUMMARY
          echo "- [\`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest\`](https://github.com/${{ github.repository }}/pkgs/container/backend)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend:**" >> $GITHUB_STEP_SUMMARY
          echo "- [\`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version-info.outputs.version }}\`](https://github.com/${{ github.repository }}/pkgs/container/frontend)" >> $GITHUB_STEP_SUMMARY
          echo "- [\`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest\`](https://github.com/${{ github.repository }}/pkgs/container/frontend)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.KUBE_ACCESS }}" == "true" ]; then
            echo "### ðŸš€ Live Application" >> $GITHUB_STEP_SUMMARY
            echo "**DelBot ${{ steps.version-info.outputs.version }} is now live!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ **Frontend:** [http://delbot.boysthings.top/](http://delbot.boysthings.top/)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”§ **Backend API:** [http://delbot.boysthings.top/api/health](http://delbot.boysthings.top/api/health)" >> $GITHUB_STEP_SUMMARY
            echo "- â¤ï¸ **Health Check:** [http://delbot.boysthings.top/health](http://delbot.boysthings.top/health)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Kubernetes Status" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Check deployment status" >> $GITHUB_STEP_SUMMARY
            echo "helm status delbot" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# View pods" >> $GITHUB_STEP_SUMMARY
            echo "kubectl get pods -n delbot" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸš€ Manual Deployment" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Deploy manually using Helm" >> $GITHUB_STEP_SUMMARY
            echo "./deploy.sh --version ${{ steps.version-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Or using Docker" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY  
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Display version file
        run: |
          echo "ðŸ“„ Final version.ts content:"
          echo "================================"
          cat frontend/src/version.ts
          echo "================================"